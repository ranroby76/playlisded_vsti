name: Build macOS (VST3/CLAP)

on:
  workflow_dispatch:

jobs:
  build_mac:
    name: Build macOS VST3 + CLAP
    runs-on: macos-14
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Dependencies
        run: |
          brew install ninja
          brew install cmake || brew upgrade cmake

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Import Signing Certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
          P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: "admin"
        run: |
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign:,productsign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

      - name: Clone JUCE 8.0.12 Framework
        run: |
          git clone --depth 1 --branch 8.0.12 https://github.com/juce-framework/JUCE.git libs/JUCE

      - name: Setup CLAP Extensions
        run: |
          git clone --recursive https://github.com/free-audio/clap-juce-extensions.git libs/CLAP_Extensions

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
            -DJUCE_DIR=libs/JUCE \
            -DCLAP_EXTENSIONS_DIR=libs/CLAP_Extensions \
            -DPLAYLISTED_ENABLE_VST3=ON \
            -DPLAYLISTED_ENABLE_AU=OFF \
            -DPLAYLISTED_ENABLE_CLAP=ON

      - name: Build All
        run: cmake --build build --config Release --parallel 4

      - name: Verify Build
        run: |
          echo "=== Checking build artefacts ==="
          find build/Playlisted_artefacts/Release -type d -name "*.vst3" -o -name "*.clap" | head -10
          
          if [ -d "build/Playlisted_artefacts/Release/VST3/Playlisted2.vst3" ]; then
            echo "VST3 found!"
            find "build/Playlisted_artefacts/Release/VST3/Playlisted2.vst3" -type f | head -10
          else
            echo "::error::VST3 NOT found!"
            find build/Playlisted_artefacts/ -type f | head -20
            exit 1
          fi
          
          if [ -d "build/Playlisted_artefacts/Release/CLAP/Playlisted2.clap" ]; then
            echo "CLAP found!"
          else
            echo "::warning::CLAP bundle not found"
          fi

      - name: Create Notarization Script
        run: |
          cat > notarize_mac.sh << 'EOF'
          #!/bin/bash
          set -e
          
          security unlock-keychain -p "admin" build.keychain
          IDENTITY=$(security find-identity -v -p codesigning build.keychain | head -1 | grep '"' | sed 's/^.*"\(.*\)".*$/\1/')
          echo "Signing with identity: $IDENTITY"
          
          sign_bundle() {
            local BUNDLE_PATH="$1"
            local BUNDLE_NAME=$(basename "$BUNDLE_PATH")
            echo "=== Signing $BUNDLE_NAME ==="
            
            # Sign inner binaries first (inside-out, no --deep)
            find "$BUNDLE_PATH" -type f \( -name "*.dylib" -o -name "*.so" \) \
              -exec codesign --force --strict --options runtime --sign "$IDENTITY" --timestamp {} \;

            find "$BUNDLE_PATH" -type d -name "*.framework" \
              -exec codesign --force --strict --options runtime --sign "$IDENTITY" --timestamp {} \;

            # Sign PlaylistedEngine executable
            if [ -f "$BUNDLE_PATH/Contents/Resources/PlaylistedEngine" ]; then
              codesign --force --strict --options runtime --sign "$IDENTITY" --timestamp "$BUNDLE_PATH/Contents/Resources/PlaylistedEngine"
            fi

            # Sign the outer bundle
            codesign --force --strict --options runtime --sign "$IDENTITY" --timestamp "$BUNDLE_PATH"
            
            # Verify
            codesign --verify --strict --verbose=2 "$BUNDLE_PATH"
            echo "$BUNDLE_NAME signed successfully"
          }
          
          notarize_bundle() {
            local BUNDLE_PATH="$1"
            local ZIP_NAME="$2"
            
            /usr/bin/ditto -c -k --keepParent "$BUNDLE_PATH" "$ZIP_NAME"
            
            xcrun notarytool submit "$ZIP_NAME" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$TEAM_ID" \
              --wait
            
            xcrun stapler staple "$BUNDLE_PATH" || echo "Stapling failed (non-critical)"
          }
          
          # --- VST3 ---
          if [ -d "build/Playlisted_artefacts/Release/VST3/Playlisted2.vst3" ]; then
            sign_bundle "build/Playlisted_artefacts/Release/VST3/Playlisted2.vst3"
            notarize_bundle "build/Playlisted_artefacts/Release/VST3/Playlisted2.vst3" "Playlisted2_VST3.zip"
          fi
          
          # --- CLAP ---
          if [ -d "build/Playlisted_artefacts/Release/CLAP/Playlisted2.clap" ]; then
            sign_bundle "build/Playlisted_artefacts/Release/CLAP/Playlisted2.clap"
            notarize_bundle "build/Playlisted_artefacts/Release/CLAP/Playlisted2.clap" "Playlisted2_CLAP.zip"
          fi
          EOF
          chmod +x notarize_mac.sh

      - name: Sign & Notarize with Retry
        uses: nick-fields/retry@v3
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_USERNAME }}
          APPLE_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
          TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 60
          command: ./notarize_mac.sh

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts_mac
          if [ -d "build/Playlisted_artefacts/Release/VST3/Playlisted2.vst3" ]; then
            cp -R "build/Playlisted_artefacts/Release/VST3/Playlisted2.vst3" artifacts_mac/
          fi
          if [ -d "build/Playlisted_artefacts/Release/CLAP/Playlisted2.clap" ]; then
            cp -R "build/Playlisted_artefacts/Release/CLAP/Playlisted2.clap" artifacts_mac/
          fi

      - name: Upload Mac Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Playlisted2-Mac-VST3-CLAP-Signed
          path: artifacts_mac/
          if-no-files-found: error
